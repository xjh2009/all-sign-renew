name: è‡ªåŠ¨ç­¾åˆ°ç»­è´¹éº¦å—è”æœº

on:
  schedule:
    - cron: '0 4 * * *' # æ¯å¤© 4 ç‚¹è¿è¡Œ
  workflow_dispatch:

jobs:
  read-and-access:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          libnss3 \
          libxss1 \
          libasound2 \
          libx11-xcb1 \
          libxcomposite1 \
          libxcursor1 \
          libxdamage1 \
          libxrandr2 \
          libgbm1 \
          libgtk-3-0   
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt-get install -f -y
        python -m ensurepip --upgrade  # ç¡®ä¿ pip å·²å®‰è£…
        pip install -U pip
        pip install -r requirements.txt 
        
    - name: ç­¾åˆ°ç»­è´¹éº¦å—è”æœº
      env:
        MK_TOKENS: ${{ secrets.MK_TOKENS }}
      run: |
        #!/bin/bash
        set -e

        IFS=',' read -r -a entries <<< "$MK_TOKENS"

        for entry in "${entries[@]}"; do
          IFS=':' read -r user password server <<< "$entry"
          cd minekuai
          echo "ğŸ” æ­£åœ¨å°è¯•ç™»å½•..."
          python main.py --username $user --password $password
          #æ£€æŸ¥ local.s æ˜¯å¦æœ‰å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¡¨ç¤ºç™»å½•å¤±è´¥

          if [ ! -s local.s ]; then
            echo "âŒ ç™»å½•å¤±è´¥ï¼Œlocal.s æ–‡ä»¶ä¸ºç©ºï¼è¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ã€‚"
            continue
          fi

          access_token=$(cat local.s)
          user_agent=$(cat u.a)

          # ç­¾åˆ°
          echo "âœ… ç™»å½•æˆåŠŸï¼Œå¼€å§‹ç­¾åˆ°..."
          sign_response=$(curl -s 'https://api.minekuai.com/system/sign' \
            -H "authorization: Bearer $access_token" \
            -H "clientid: 3991ee92fe77fa9672e5eca721151dab" \
            -H "content-language: zh_CN" \
            -H "origin: https://minekuai.com" \
            -H "user-agent: Mozilla/5.0")

          msg_sign=$(echo "$sign_response" | jq -r '.msg')
          echo "ğŸ“Œ ç­¾åˆ°ç»“æœï¼š$msg_sign"

          # ç»­è´¹
          echo "ğŸ”„ æ­£åœ¨å°è¯•ç»­è´¹æœåŠ¡å™¨..."
          renew_response=$(curl -s -X POST "https://api.minekuai.com/system/mineKuaiSystem/reNewInstance?serverId=$server&days=1" \
            -H "authorization: Bearer $access_token" \
            -H "clientid: 3991ee92fe77fa9672e5eca721151dab" \
            -H "content-language: zh_CN" \
            -H "origin: https://minekuai.com" \
            -H "user-agent: Mozilla/5.0")
          
          rm -rf u.a local.s
          
          msg_renew=$(echo "$renew_response" | jq -r '.msg')
          echo "ğŸ”„ ç»­è´¹ç»“æœï¼š$msg_renew"

          echo "âœ… å¤„ç†å®Œæˆï¼"
          echo "---------------------------------------"
        done
